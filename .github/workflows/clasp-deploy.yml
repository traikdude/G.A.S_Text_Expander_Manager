name: ğŸš€ Clasp Auto-Deploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy-to-gas:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          npm install -g @google/clasp

      - name: ğŸ” Configure Clasp Credentials
        run: |
          mkdir -p ~/.config/clasp
          echo '${{ secrets.CLASPRC_JSON }}' > ~/.clasprc.json
          chmod 600 ~/.clasprc.json
          
          # Validate .clasp.json exists
          if [ ! -f .clasp.json ]; then
            echo "âŒ ERROR: .clasp.json not found in repository root"
            exit 1
          fi
          
          # Update scriptId from secrets if provided
          if [ -n "${{ secrets.SCRIPT_ID }}" ]; then
            jq '.scriptId = "${{ secrets.SCRIPT_ID }}"' .clasp.json > .clasp.json.tmp
            mv .clasp.json.tmp .clasp.json
          fi

      - name: ğŸš€ Push to Google Apps Script
        run: |
          clasp push --force
        env:
          CLASP_DEPLOYMENT_ID: ${{ secrets.DEPLOYMENT_ID }}

      - name: âœ… Deployment Summary
        if: success()
        run: |
          echo "::notice::âœ… Successfully deployed to Google Apps Script"
          echo "ğŸ“Š Files pushed: $(ls -1 src/ | wc -l)"
          echo "ğŸ”— Project: gas-text-expander-manager"

      - name: âŒ Failure Notification
        if: failure()
        run: |
          echo "::error::Deployment failed. Check logs above."
